<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Nourish Naija</title>
  <meta name="theme-color" content="#065f46"/>
  <link rel="manifest" href="./manifest.webmanifest"/>

  <!-- Fonts + Tailwind -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { theme:{ extend:{ fontFamily:{ sans:['Inter','ui-sans-serif','system-ui'] } } } }</script>

  <!-- React + Babel -->
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>

  <!-- PWA -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () =>
        navigator.serviceWorker.register("./sw.js?v=9").catch(console.error)
      );
    }
  </script>
</head>
<body class="bg-neutral-50 text-neutral-900 font-sans">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // ===== Brand (change this to rename everywhere) =====
    const APP_NAME = "Nourish Naija";
    document.title = APP_NAME;

    // ---------- small helpers ----------
    const slug = s => s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/(^-|-$)/g,"");
    const uniq = a => Array.from(new Set(a));
    const title = s => s[0].toUpperCase()+s.slice(1);
    const round = n => Math.round(n);
    const ing = (name,qty,unit)=>({name,qty,unit});
    const meal=(name,type,kcal,p,c,f,ingredients,steps,tags=[],keywords=[])=>({id:slug(name+"_"+type),name,type,kcal,protein:p,carbs:c,fat:f,ingredients,steps,tags,keywords});

    // ---------- recipes (trimmed for brevity; same set as v8) ----------
    const RECIPES = [
      // breakfasts
      meal("Pap/Akamu with Milk","breakfast",380,12,62,9,[ing("pap (akamu)",2,"cup"),ing("milk",1,"cup"),ing("sugar",1,"tbsp")],["Cook pap to thicken.","Serve with milk."],["african","vegetarian","gluten_free","kid_friendly"],["pap","akamu"]),
      meal("Nigerian Egg Sauce & Boiled Yam","breakfast",520,24,62,18,[ing("yam",1,"small tuber"),ing("eggs",4,""),ing("tomato",3,""),ing("onion",1,""),ing("oil",1,"tbsp")],["Boil yam.","Make egg sauce."],["contains_egg","african","kid_friendly","halal_friendly"],["yam","egg"]),
      meal("Oatmeal with Banana & Peanut Butter","breakfast",450,14,60,16,[ing("rolled oats",1,"cup"),ing("banana",1,""),ing("peanut butter",2,"tbsp"),ing("milk",1,"cup")],["Simmer oats.","Top with banana + PB."],["contains_peanut","vegetarian","quick","kid_friendly"],["oats"]),
      meal("Avocado Toast with Egg","breakfast",420,16,40,22,[ing("avocado",1,""),ing("eggs",4,""),ing("whole-grain bread",4,"slices")],["Mash avo; toast; top with egg."],["contains_gluten","contains_egg","vegetarian","quick","kid_friendly"],["avocado","bread"]),
      // lunches
      meal("Jollof Rice with Grilled Fish & Slaw","lunch",650,35,80,18,[ing("rice",2,"cup"),ing("tomato puree",1,"cup"),ing("onion",1,""),ing("bell pepper",1,""),ing("tilapia",600,"g"),ing("cabbage",0.5,"head"),ing("carrot",2,"")],["Cook jollof.","Grill fish.","Slaw."],["fish","african","halal_friendly","kid_friendly"],["rice","fish"]),
      meal("Ewa Riro (Beans Porridge) & Plantain","lunch",600,28,92,8,[ing("brown beans",2,"cup"),ing("onion",1,""),ing("palm oil",1,"tbsp"),ing("ripe plantain",2,"")],["Cook beans.","Bake/air-fry plantain."],["vegan","african","budget","kid_friendly"],["beans","plantain"]),
      meal("Moi-Moi & Salad","lunch",540,28,68,16,[ing("brown beans",2,"cup"),ing("onion",1,""),ing("oil",1,"tbsp"),ing("egg (optional)",2,""),ing("lettuce",1,"head"),ing("tomato",2,"")],["Blend & steam moi-moi.","Serve with salad."],["african","halal_friendly","contains_egg_optional","gluten_free"],["moi-moi"]),
      meal("Okra Soup with Fish & Garri","lunch",620,34,70,20,[ing("okra",600,"g"),ing("tilapia",500,"g"),ing("onion",1,""),ing("palm oil",1,"tbsp"),ing("garri",4,"servings")],["Simmer okra.","Poach fish.","Serve."],["fish","african","halal_friendly"],["okra","garri"]),
      // dinners
      meal("Egusi Soup with Eba","dinner",700,34,80,28,[ing("egusi (melon seed)",1.5,"cup"),ing("spinach",400,"g"),ing("palm oil",1,"tbsp"),ing("garri",4,"servings")],["Toast egusi; simmer.","Add spinach.","Serve with eba."],["african","gluten_free"],["egusi"]),
      meal("Ofada Rice & Ayamase","dinner",720,38,92,22,[ing("ofada rice (or brown rice)",2,"cup"),ing("beef strips",500,"g"),ing("green bell pepper",4,""),ing("onion",1,""),ing("palm oil",2,"tbsp")],["Boil rice.","Fry pepper base; add beef."],["african","spicy","halal_friendly"],["ayamase"]),
      meal("Sheet-pan Chicken & Vegetables","dinner",610,42,60,18,[ing("chicken thighs",800,"g"),ing("potatoes",4,""),ing("carrot",3,""),ing("onion",1,""),ing("olive oil",2,"tbsp")],["Roast 35–40 min @200°C."],["gluten_free","kid_friendly","halal_friendly"],["chicken"]),
      meal("Tilapia Pepper Soup with Yam","dinner",560,36,60,14,[ing("tilapia",600,"g"),ing("yam",1,"small tuber"),ing("pepper soup spice",1,"tbsp")],["Boil spiced broth; poach fish.","Serve with yam."],["fish","african","halal_friendly"],["pepper soup"]),
      meal("Veggie Couscous & Chickpeas","dinner",580,18,92,10,[ing("couscous",2,"cup"),ing("chickpeas",2,"cup"),ing("zucchini",2,""),ing("bell pepper",1,""),ing("raisins",0.25,"cup")],["Steam couscous; sauté veg; combine."],["vegetarian","contains_gluten","budget","kid_friendly"],["couscous"]),
      // snacks
      meal("Fruit Salad","snack",180,3,42,1,[ing("mango",1,""),ing("pineapple",0.5,""),ing("grapes",1,"cup")],["Chop fruit; toss."],["vegan","quick","kid_friendly"],["fruit"]),
      meal("Boli & Groundnuts","snack",300,8,48,10,[ing("ripe plantain",2,""),ing("peanuts",0.5,"cup")],["Roast plantain; serve with peanuts."],["african","contains_peanut","quick"],["plantain"])
    ];

    // ---------- rough prices (NGN) ----------
    const DEFAULTS={fx:1600,fallback:{perCup:300,perPiece:200,perKg:6000,perTbsp:80}};
    const pricePiece={"banana":150,"avocado":700,"egg":120,"eggs":120,"onion":150,"tomato":120,"bell pepper":200,"green bell pepper":200,"lemon":200,"ripe plantain":300,"plantain":300,"cucumber":300,"zucchini":400,"mango":500,"lime":120,"carrot":150,"yam":1500};
    const priceUnit={"milk|cup":300,"pap (akamu)|cup":200,"peanut butter|tbsp":120,"olive oil|tbsp":120,"palm oil|tbsp":70,"garri|servings":150,"rice|cup":250,"tomato puree|cup":300,"couscous|cup":300,"chickpeas|cup":250,"brown beans|cup":220,"grapes|cup":800,"whole-grain bread|slices":60};
    const priceKg={"tilapia":5000,"chicken thighs":5500,"spinach":1200,"okra":800};
    const priceHead={"cabbage":800,"lettuce":700};
    const alias={"ripe plantain":"plantain","pap/akamu":"pap (akamu)","egg (optional)":"egg"};

    const normalizeName=n=>(alias[n]||n).toLowerCase();
    function priceNgnForItem(name,qty,unit){
      const n=normalizeName(name),u=(unit||"").toLowerCase(),key=n+"|"+u;
      if (priceUnit[key]!=null) return qty*priceUnit[key];
      if (!u && pricePiece[n]!=null) return qty*pricePiece[n];
      if (u==="head" && priceHead[n]!=null) return qty*priceHead[n];
      if (u==="g"||u==="kg"){const per=priceKg[n]??DEFAULTS.fallback.perKg;const kg=u==="kg"?qty:qty/1000;return kg*per;}
      if (u==="cup")  return qty*(priceUnit[n+"|cup"]??DEFAULTS.fallback.perCup);
      if (u==="tbsp") return qty*(priceUnit[n+"|tbsp"]??DEFAULTS.fallback.perTbsp);
      if (u==="servings"||u==="slices") return qty*(priceUnit[key]??DEFAULTS.fallback.perPiece);
      return qty*DEFAULTS.fallback.perPiece;
    }
    const estimateRecipeCostNgn = r => r.ingredients.reduce((s,i)=>s+priceNgnForItem(i.name,i.qty||0,i.unit||""),0);
    const estimateTime = r => r.tags.includes("quick") ? 15 : (/roast|bake|couscous|stew|soup|rice/.test(r.steps.join(" ").toLowerCase()) ? 40 : 25);

    // ---------- UI bits ----------
    const Card = ({className="",children}) => (
      <div className={"rounded-2xl border border-neutral-200 bg-white/80 backdrop-blur shadow-[0_6px_30px_-12px_rgba(0,0,0,.25)] "+className}>{children}</div>
    );
    const Toggle = ({checked,onChange}) => (
      <button onClick={()=>onChange(!checked)}
        className={"px-3 py-1.5 rounded-full border text-sm transition "+(checked?"bg-emerald-600 text-white border-emerald-600 shadow":"bg-white border-neutral-300 hover:bg-neutral-50")}>
        {checked ? "On" : "Off"}
      </button>
    );
    function MealCard({type,recipe,onSwap}){
      if(!recipe) return null; const est=estimateTime(recipe);
      return (
        <div className="rounded-xl border border-neutral-200 p-3 bg-white/70">
          <div className="flex items-center justify-between mb-2">
            <div>
              <div className="uppercase tracking-wide text-[11px] text-neutral-500">{type}</div>
              <div className="font-semibold">{recipe.name}</div>
            </div>
            <button className="text-sm text-emerald-700 hover:underline" onClick={onSwap}>Swap</button>
          </div>
          <div className="text-xs text-neutral-600">~{est} min • {Math.round(recipe.kcal)} kcal • P{recipe.protein} C{recipe.carbs} F{recipe.fat}</div>
          <details className="mt-2">
            <summary className="cursor-pointer text-sm text-neutral-800">Ingredients</summary>
            <ul className="mt-1 text-sm list-disc ml-5">{recipe.ingredients.map((i,k)=><li key={k}>{i.qty} {i.unit} {i.name}</li>)}</ul>
          </details>
        </div>
      );
    }

    // ---------- main app ----------
    function App(){
      const initialPrefs={familySize:4,diet:"omnivore",halal:true,kidFriendly:true,africanFocus:true,spice:"mild",allergies:[],dislikes:[],timePerMeal:30,currency:"NGN",fxNgnPerUsd:1600,budgetPerDay:0};
      const [prefs,setPrefs]=useState(()=>JSON.parse(localStorage.getItem("mealbot:prefs.v9")||"null")||initialPrefs);
      const [weekPlan,setWeekPlan]=useState(()=>JSON.parse(localStorage.getItem("mealbot:weekPlan.v9")||"null"));
      const [input,setInput]=useState(""); const [days,setDays]=useState(7);

      useEffect(()=>localStorage.setItem("mealbot:prefs.v9",JSON.stringify(prefs)),[prefs]);
      useEffect(()=>localStorage.setItem("mealbot:weekPlan.v9",JSON.stringify(weekPlan)),[weekPlan]);

      // NLP: ASCII-safe ₦
      function applyNLP(text,p){ let n={...p};
        const fam=text.match(/(family (of|size)\s*(\d+))|we (are|\'re)\s*(\d+)/i); if(fam){const num=parseInt(fam[3]||fam[5],10); if(num>0&&num<20)n.familySize=num;}
        const b=text.match(/(?:\u20A6|NGN|N|\$)?\s*(\d{2,6})\s*(?:per day|\/day|daily)/i); if(b) n.budgetPerDay=parseInt(b[1],10);
        const t=text.match(/(\d{2,3}) ?min/i); if(t){const m=+t[1]; if(m>=10&&m<=120)n.timePerMeal=m;}
        if(/vegan/i.test(text)) n.diet="vegan"; else if(/vegetarian/i.test(text)) n.diet="vegetarian"; else if(/pescatarian/i.test(text)) n.diet="pescatarian";
        if(/halal/i.test(text)) n.halal=true; if(/kid|children/i.test(text)) n.kidFriendly=true; if(/nigerian|african/i.test(text)) n.africanFocus=true;
        return n;
      }

      function filterRecipes(type){
        return RECIPES.filter(r=>r.type===type)
          .filter(r=>prefs.timePerMeal>=estimateTime(r));
      }
      function pickBest(type){ const opts=filterRecipes(type); return opts[Math.floor(Math.random()*opts.length)]; }

      function generatePlan(n=7){
        const out=[];
        for(let d=0; d<n; d++){
          const m={breakfast:pickBest("breakfast"),lunch:pickBest("lunch"),dinner:pickBest("dinner"),snack:RECIPES.find(r=>r.type==="snack")};
          const totals=Object.values(m).reduce((a,r)=>({kcal:a.kcal+r.kcal,p:a.p+r.protein,c:a.c+r.carbs,f:a.f+r.fat}),{kcal:0,p:0,c:0,f:0});
          // scale costs by family size
          const mult=(type)=> type==="snack" ? prefs.familySize/prefs.familySize : prefs.familySize/2;
          const dayCost=Math.round(price(m.breakfast)*mult("breakfast")+price(m.lunch)*mult("lunch")+price(m.dinner)*mult("dinner")+price(m.snack)*mult("snack"));
          out.push({meals:m,totals,costNgn:dayCost});
        }
        setWeekPlan(out);
      }
      const price=r=>estimateRecipeCostNgn(r);
      const avgDayCost=weekPlan && weekPlan.length? Math.round(weekPlan.reduce((s,d)=>s+d.costNgn,0)/weekPlan.length):null;

      const overBudget=prefs.budgetPerDay && avgDayCost && avgDayCost>prefs.budgetPerDay;

      return (
        <div className="min-h-screen">
          {/* Pretty gradient header */}
         <header className="bg-gradient-to-r from-orange-600 via-amber-500 to-orange-400 text-white">
  <div className="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div className="flex items-center gap-3">
      <img src="./logo.svg" alt="Nourish Naija" className="h-8 w-auto" />
      <div className="font-extrabold text-xl tracking-tight">Nourish Naija</div>
    </div>
    <span className="text-xs bg-white/15 px-2 py-1 rounded-full">v11</span>
  </div>
</header>

          <main className="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
            {/* Controls */}
            <Card className="p-5">
              <div className="flex items-center justify-between mb-3">
                <h2 className="text-lg font-semibold">Preferences</h2>
                <button className="text-sm text-emerald-700 hover:underline" onClick={()=>setPrefs({familySize:4,diet:"omnivore",halal:true,kidFriendly:true,africanFocus:true,spice:"mild",allergies:[],dislikes:[],timePerMeal:30,currency:"NGN",fxNgnPerUsd:1600,budgetPerDay:0})}>Reset</button>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div><label className="text-xs text-neutral-600">Family size</label><input type="number" min="1" max="16" value={prefs.familySize} onChange={e=>setPrefs({...prefs,familySize:+e.target.value})} className="w-full border rounded-lg px-2 py-1"/></div>
                <div><label className="text-xs text-neutral-600">Diet</label><select value={prefs.diet} onChange={e=>setPrefs({...prefs,diet:e.target.value})} className="w-full border rounded-lg px-2 py-1"><option>omnivore</option><option>pescatarian</option><option>vegetarian</option><option>vegan</option></select></div>
                <div><label className="text-xs text-neutral-600">Halal-friendly</label><Toggle checked={prefs.halal} onChange={v=>setPrefs({...prefs,halal:v})}/></div>
                <div><label className="text-xs text-neutral-600">Kid-friendly</label><Toggle checked={prefs.kidFriendly} onChange={v=>setPrefs({...prefs,kidFriendly:v})}/></div>
                <div><label className="text-xs text-neutral-600">African focus</label><Toggle checked={prefs.africanFocus} onChange={v=>setPrefs({...prefs,africanFocus:v})}/></div>
                <div><label className="text-xs text-neutral-600">Time per meal (min)</label><input type="number" min="10" max="120" value={prefs.timePerMeal} onChange={e=>setPrefs({...prefs,timePerMeal:+e.target.value})} className="w-full border rounded-lg px-2 py-1"/></div>
                <div><label className="text-xs text-neutral-600">FX (₦ per $)</label><input type="number" value={prefs.fxNgnPerUsd} onChange={e=>setPrefs({...prefs,fxNgnPerUsd:+e.target.value})} className="w-full border rounded-lg px-2 py-1"/></div>
                <div className="col-span-2"><label className="text-xs text-neutral-600">Budget/day (₦)</label><input type="number" value={prefs.budgetPerDay} onChange={e=>setPrefs({...prefs,budgetPerDay:+e.target.value})} className="w-full border rounded-lg px-2 py-1"/></div>
              </div>
              <div className="flex gap-2 mt-4">
                <button className="px-3 py-2 rounded-lg border hover:bg-neutral-50" onClick={()=>{setDays(1);generatePlan(1);}}>Generate daily</button>
                <button className="px-3 py-2 rounded-lg bg-emerald-600 text-white shadow hover:bg-emerald-700" onClick={()=>{setDays(7);generatePlan(7);}}>Generate weekly</button>
              </div>

              <div className="mt-5">
                <label className="text-xs text-neutral-600">Quick apply by text</label>
                <div className="flex gap-2 mt-1">
                  <input className="w-full border rounded-lg px-2 py-1" value={input} placeholder="e.g., family of 5, ₦15000 per day, 30 min" onChange={e=>setInput(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'){setPrefs(applyNLP(input,prefs));setInput('');}}}/>
                  <button className="px-3 py-2 rounded-lg border hover:bg-neutral-50" onClick={()=>{setPrefs(applyNLP(input,prefs));setInput('');}}>Apply</button>
                </div>
              </div>
            </Card>

            {/* Plan + list */}
            <div className="lg:col-span-2 space-y-5">
              <Card className="p-5">
                <div className="flex items-baseline justify-between flex-wrap gap-2">
                  <h2 className="text-lg font-semibold">{days===1?"Today’s Menu":"Weekly Menu"}</h2>
                  {weekPlan && (
                    <div className="text-sm flex gap-2 items-center">
                      <span className="px-2 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">Avg/day: ₦{avgDayCost?.toLocaleString()}</span>
                      {prefs.budgetPerDay ? (
                        <span className={"px-2 py-1 rounded-full border "+(overBudget?"bg-red-50 text-red-700 border-red-200":"bg-green-50 text-green-700 border-green-200")}>
                          {overBudget?"Above budget":"Within budget"}
                        </span>
                      ):null}
                      <button className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50" onClick={()=>generatePlan(days)}>Regenerate</button>
                    </div>
                  )}
                </div>

                {!weekPlan && <p className="text-sm text-neutral-600 mt-2">No plan yet. Click <span className="font-medium">Generate</span>.</p>}

                {weekPlan && (
                  <div className="mt-4 space-y-4">
                    {weekPlan.map((d,i)=>(
                      <div key={i} className="rounded-2xl border border-neutral-200 p-3 bg-white/70">
                        <div className="flex items-center justify-between">
                          <h3 className="font-semibold">Day {i+1}</h3>
                          <span className="text-sm bg-neutral-100 border rounded px-2 py-0.5">~ ₦{d.costNgn.toLocaleString()}</span>
                        </div>
                        <div className="grid md:grid-cols-2 gap-3 mt-3">
                          {["breakfast","lunch","dinner","snack"].map(t=>(
                            <MealCard key={t} type={t} recipe={d.meals[t]} onSwap={()=>{ /* Simplified swap: regen that slot */ const repl = pickBest(t); const copy=[...weekPlan]; copy[i]={...copy[i], meals:{...copy[i].meals,[t]:repl}}; setWeekPlan(copy); }}/>
                          ))}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </Card>

              <Card className="p-5">
                <div className="flex items-baseline justify-between">
                  <h2 className="text-lg font-semibold">Family Shopping List</h2>
                  <button disabled={!weekPlan} className="px-3 py-1.5 rounded-lg border hover:bg-neutral-50 disabled:opacity-50" onClick={()=>downloadList(buildShoppingList(weekPlan))}>Download</button>
                </div>
                {!weekPlan && <p className="text-sm text-neutral-600 mt-2">Generate a plan to see the shopping list.</p>}
                {weekPlan && (
                  <ul className="mt-3 grid sm:grid-cols-2 gap-x-6 gap-y-1 text-sm">
                    {buildShoppingList(weekPlan).map((i,idx)=>(
                      <li key={idx} className="flex items-center justify-between border-b border-neutral-100 py-1">
                        <span>{i.name}</span><span className="tabular-nums text-neutral-700">{i.qty} {i.unit}</span>
                      </li>
                    ))}
                  </ul>
                )}
              </Card>
            </div>
          </main>

          <footer className="max-w-6xl mx-auto px-4 pb-10 text-xs text-neutral-500">
            Need a different accent color or custom logo? Replace the gradient classes in the header and upload icons (see below).
          </footer>
        </div>
      );
    }

    // ===== utilities reused in App =====
    function buildShoppingList(plan){ if(!plan) return []; const fam=4; const bag={}; for(const day of plan){ for(const type of ["breakfast","lunch","dinner","snack"]){ for(const it of day.meals[type].ingredients){ const key=(normalizeName(it.name)+"|"+(it.unit||"")).toLowerCase(); if(!bag[key]) bag[key]={name:normalizeName(it.name),qty:0,unit:it.unit||""}; bag[key].qty+= (it.qty||0); } } } for(const k of Object.keys(bag)) bag[k].qty=Math.round(bag[k].qty*10)/10; return Object.values(bag).sort((a,b)=>a.name.localeCompare(b.name)); }
    function downloadList(list){ const blob=new Blob([["Shopping List","",...list.map(i=>`• ${i.name} — ${i.qty} ${i.unit}`)].join("\n")],{type:"text/plain"}); const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="shopping-list.txt"; a.click(); URL.revokeObjectURL(url); }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
