<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Family Meal Planner Chatbot</title>
  <meta name="theme-color" content="#111827" />
  <link rel="manifest" href="./manifest.webmanifest" />

  <!-- PWA: register service worker (cache-busted) -->
  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        console.log("[PWA] Registering SW‚Ä¶");
        navigator.serviceWorker.register("./sw.js?v=6")
          .catch(err => console.error("[PWA] SW error", err));
      });
    }
  </script>

  <!-- Libraries via jsDelivr (avoid adblock issues) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-neutral-50 text-neutral-900">
  <div id="root"></div>

  <!-- App -->
  <script type="text/babel">
    const { useState } = React;

    // Small recipe set (Nigerian-friendly)
    const R = {
      breakfast: [
        {name:"Pap/Akamu with Milk", kcal:380, p:12,c:62,f:9, ingredients:[["pap (akamu)",2,"cup"],["milk",1,"cup"],["sugar",1,"tbsp"]], steps:["Cook pap until thick.","Serve with milk."], tags:["african","kid"]},
        {name:"Egg Sauce & Boiled Yam", kcal:520, p:24,c:62,f:18, ingredients:[["yam",1,"small tuber"],["eggs",4,""],["tomato",3,""],["onion",1,""],["oil",1,"tbsp"]], steps:["Boil yam.","Make egg sauce with tomato & onion."], tags:["african","egg"]}
      ],
      lunch: [
        {name:"Jollof Rice & Grilled Fish", kcal:650,p:35,c:80,f:18, ingredients:[["rice",2,"cup"],["tomato puree",1,"cup"],["onion",1,""],["bell pepper",1,""],["tilapia",600,"g"]], steps:["Cook jollof.","Grill fish."], tags:["african","fish"]},
        {name:"Beans (Ewa Riro) & Plantain", kcal:600,p:28,c:92,f:8, ingredients:[["brown beans",2,"cup"],["onion",1,""],["palm oil",1,"tbsp"],["ripe plantain",2,""]], steps:["Cook beans.","Bake/air-fry plantain."], tags:["african","vegan"]}
      ],
      dinner: [
        {name:"Egusi Soup with Eba", kcal:700,p:34,c:80,f:28, ingredients:[["egusi",1.5,"cup"],["spinach",400,"g"],["palm oil",1,"tbsp"],["garri",4,"servings"]], steps:["Simmer egusi.","Add spinach.","Serve with eba."], tags:["african"]},
        {name:"Sheet-pan Chicken & Veg", kcal:610,p:42,c:60,f:18, ingredients:[["chicken thighs",800,"g"],["potatoes",4,""],["carrot",3,""],["onion",1,""],["olive oil",2,"tbsp"]], steps:["Toss & roast 35‚Äì40 min @200¬∞C."], tags:["halal"]}
      ],
      snack: [
        {name:"Fruit Salad", kcal:180,p:3,c:42,f:1, ingredients:[["mango",1,""],["pineapple",0.5,""],["grapes",1,"cup"]], steps:["Chop fruit."], tags:["vegan"]},
        {name:"Boli (Roasted Plantain) & Groundnuts", kcal:300,p:8,c:48,f:10, ingredients:[["ripe plantain",2,""],["peanuts",0.5,"cup"]], steps:["Roast plantain.","Serve with peanuts."], tags:["african","peanut"]}
      ]
    };

    // Very rough Nigeria price table (edit in code)
    const pricePiece = {"onion":150,"tomato":120,"ripe plantain":300,"plantain":300,"carrot":150,"yam":1500,"eggs":120,"egg":120,"mango":500,"pineapple":1200};
    const priceUnit  = {"rice|cup":250,"tomato puree|cup":300,"milk|cup":300,"pap (akamu)|cup":200,"olive oil|tbsp":120,"palm oil|tbsp":70,"garri|servings":150,"grapes|cup":800};
    const priceKg    = {"tilapia":5000,"chicken thighs":5500,"spinach":1200};
    const alias      = {"ripe plantain":"plantain","egg (optional)":"egg"};

    function priceNgn(name, qty, unit) {
      const n = (alias[name] || name).toLowerCase();
      const u = (unit||"").toLowerCase();
      const key = `${n}|${u}`;
      if (priceUnit[key] != null) return qty * priceUnit[key];
      if ((!u || u==="") && pricePiece[n] != null) return qty * pricePiece[n];
      if (u==="g"||u==="kg") { const kg = u==="kg" ? qty : qty/1000; const per = priceKg[n] || 6000; return kg*per; }
      if (u==="cup")  return qty * (priceUnit[`${n}|cup`]  || 300);
      if (u==="tbsp") return qty * (priceUnit[`${n}|tbsp`] || 80);
      if (u==="servings") return qty * (priceUnit[key] || 200);
      return qty * 200;
    }

    function costOf(recipe, familySize, type) {
      // Recipes are 2 servings by default; snacks per person
      const baseServes = type === "snack" ? familySize : 2;
      const mult = familySize / baseServes;
      let ngn = 0;
      for (const [name, qty, unit] of recipe.ingredients) ngn += priceNgn(name, qty, unit);
      return Math.round(ngn * mult);
    }

    function App(){
      const [prefs, setPrefs] = useState({familySize:4, currency:'NGN', fx:1600, budgetPerDay:0});
      const [plan, setPlan] = useState(null);
      const [chat, setChat] = useState("");

      // NLP: update prefs from text (fix: ASCII-safe ‚Ç¶)
      function applyNLP(text){
        const next = {...prefs};
        const fam = text.match(/family (of|size)\s*(\d+)/i) || text.match(/we (are|\'re)\s*(\d+)/i);
        if (fam) next.familySize = parseInt(fam[2],10);
        const b = text.match(/(?:\u20A6|NGN|N|\$)?\s*(\d{2,6})\s*(?:per day|\/day|daily)/i);
        if (b) next.budgetPerDay = parseInt(b[1],10);
        setPrefs(next);
      }

      function generate(days=7){
        const out = [];
        for (let d=0; d<days; d++){
          const day = {
            breakfast: R.breakfast[d%R.breakfast.length],
            lunch:     R.lunch[d%R.lunch.length],
            dinner:    R.dinner[d%R.dinner.length],
            snack:     R.snack[d%R.snack.length]
          };
          const cost = (
            costOf(day.breakfast, prefs.familySize, "breakfast") +
            costOf(day.lunch,     prefs.familySize, "lunch") +
            costOf(day.dinner,    prefs.familySize, "dinner") +
            costOf(day.snack,     prefs.familySize, "snack")
          );
          out.push({ day, cost });
        }
        setPlan(out);
      }

      const avg = plan && Math.round(plan.reduce((s,x)=>s+x.cost,0)/plan.length);

      return (
        <div className="max-w-6xl mx-auto p-4">
          <header className="mb-4 flex items-center justify-between">
            <h1 className="text-2xl font-bold">üç≤ Family Meal Planner</h1>
            <div className="text-sm text-neutral-600">Currency: NGN ‚Ä¢ FX: ‚Ç¶{prefs.fx}/$</div>
          </header>

          <div className="grid md:grid-cols-3 gap-4">
            <section className="space-y-3">
              <div className="bg-white border rounded-2xl p-4">
                <h2 className="font-semibold mb-2">Preferences</h2>
                <label className="text-sm block mb-1">Family size</label>
                <input type="number" value={prefs.familySize}
                  onChange={e=>setPrefs({...prefs, familySize:+e.target.value})}
                  className="w-full border rounded px-2 py-1 mb-2"/>

                <label className="text-sm block mb-1">Budget / day (‚Ç¶)</label>
                <input type="number" value={prefs.budgetPerDay}
                  onChange={e=>setPrefs({...prefs, budgetPerDay:+e.target.value})}
                  className="w-full border rounded px-2 py-1 mb-3"/>

                <div className="flex gap-2">
                  <button className="px-3 py-1.5 border rounded" onClick={()=>generate(1)}>Generate daily</button>
                  <button className="px-3 py-1.5 border rounded bg-neutral-900 text-white" onClick={()=>generate(7)}>Generate weekly</button>
                </div>
              </div>

              <div className="bg-white border rounded-2xl p-4">
                <h3 className="font-semibold mb-2">Chat (optional)</h3>
                <input placeholder="e.g., family of 5, ‚Ç¶15000 per day"
                  value={chat} onChange={e=>setChat(e.target.value)}
                  onKeyDown={e=>{if(e.key==='Enter'){applyNLP(chat); setChat('');}}}
                  className="w-full border rounded px-2 py-1 mb-2"/>
                <button className="px-3 py-1.5 border rounded" onClick={()=>{applyNLP(chat); setChat('');}}>Apply</button>
                <p className="text-xs text-neutral-500 mt-2">Tip: I understand ‚Äúfamily of 6‚Äù and ‚Äú‚Ç¶12000 per day‚Äù.</p>
              </div>
            </section>

            <section className="md:col-span-2 space-y-4">
              <div className="bg-white border rounded-2xl p-4">
                <div className="flex items-center justify-between">
                  <h2 className="font-semibold">Menu</h2>
                  {plan && <span className="text-sm">Avg est. cost/day: ‚Ç¶{avg?.toLocaleString()}</span>}
                </div>

                {!plan && <p className="text-sm text-neutral-600 mt-2">Click Generate to build a plan.</p>}

                {plan && (
                  <div className="mt-3 space-y-4">
                    {plan.map((p, i)=>(
                      <div key={i} className="border rounded-xl p-3">
                        <div className="flex items-center justify-between mb-2">
                          <h3 className="font-semibold">Day {i+1}</h3>
                          <span className="text-sm bg-neutral-100 border rounded px-2 py-0.5">~ ‚Ç¶{p.cost.toLocaleString()}</span>
                        </div>
                        <ul className="grid sm:grid-cols-2 gap-2 text-sm">
                          {["breakfast","lunch","dinner","snack"].map(t=>(
                            <li key={t} className="border rounded p-2">
                              <div className="font-medium capitalize">{t}</div>
                              <div>{p.day[t].name}</div>
                            </li>
                          ))}
                        </ul>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </section>
          </div>

          <footer className="text-xs text-neutral-500 mt-6">
            If you ever see a blank screen, hard refresh or bump the SW query (?v=6) in index.html.
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
  </script>
</body>
</html>
